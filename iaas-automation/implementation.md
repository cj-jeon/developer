# 各手順の実装

ここでは、各手順において以下を説明します。
- 概要：手順で行なう作業の概要
- 必要な機能：実装するべき機能
- 実装時の注意点：制限事項等
- 実装サンプル ※1 例（【実装ファイル※2】）：手順のサンプルでの実装内容

---
※1：実装サンプルにおいて、すでに説明した機能がある場合、説明を簡略化する場合があります。

※2：実装ファイル(jmxファイル)の中身を確認する場合、以下の手順で開きます。
- JMeterをGUIモードで起動
- 「ファイル」＞「開く」の順にクリック
- 該当するファイルを選択し「開く」をクリック
---

各手順の説明は、基本的にその手順内に留まっており、手順間の連携については「手順の連携」を参照してください。
各手順の入出力については、「参考＞実装サンプルの各手順の入出力表」にまとめられています。

同じような作業を複数回行う可能性があるため、必須ではありませんが、
以下のような各手順を部品化することを推奨します。
- サーバごとのキーペアの作成
- SSL-VPN用ネットワークID取得・SSL-VPN用サブネットID取得

API の内、リソースの GET や DELETE を行なうものは、リクエストボディを作成する必要がなく、レスポンスボティが JSON で返されるものが多いため、汎用的な部品を作成することも考慮してください。

### 認証(API)

- 概要

  アカウント及びプロジェクト情報を使用して、IaaSの認証APIから以下の情報を取得します。
  - 認証APIを除く各APIを実行する為に必要なトークン
  - 認証を行ったアカウントで利用可能なエンドポイントの情報(カタログ)
  - 認証したプロジェクトID

  取得した各値は、今後のAPIリクエスト時に利用されます。
  認証のエンドポイントは以下のような形式になっています。
  - グローバルサービス※：https://identity.gls.cloud.global.fujitsu.com
  - ローカルサービス※：https://identity.{リージョン識別子}.cloud.global.fujitsu.com

  ※ ローカルサービスはリージョンに基づくサービス、グローバルサービスはリージョンに依存しないサービスです。詳細は機能説明書を参照してください。

- 必要な機能

  WebAPIのリクエスト機能(POST)が必要になります。
  リクエストボディとレスポンスボディのフォーマットはjsonとなっている為、jsonを扱える必要があります。

- 実装時の注意点

  1. ローカルサービスのエンドポイント
    ローカルサービスの認証を受ける場合、上述のように使用するリージョンによりエンドポイントが変わる為、注意が必要です。
  1. トークンの有効期限
    トークンには有効期限がある為、期限が切れた場合のフォローを考えておく必要があります。
    サンプルでは各APIを呼び出す前に、毎回認証を行なうようにしています。

- 実装サンプル(module/auth.jmx)

  サンプルでは以下の手順で処理を行っています。
  1. 認証リクエスト
  1. トークン抽出
  1. カタログ抽出
  1. プロジェクトID抽出

  以下、各手順の詳細です。
  1. 認証リクエスト
     JMeterのHTTPリクエスト機能を使用してAPIリクエストを行っています。
     ![認証リクエスト](images/auth-request.jpg)
     リクエストボディについては、以下のテンプレートに対して、入力されたパラメータを当てはめるように設定します。
     ```
     {
       "auth": {
         "scope": {
           "project": {
             "domain": {
               "name": "${K5_CONTRACT}"
             },
             "name": "${K5_PROJECT}"
           }
         },
         "identity": {
           "password": {
             "user": {
               "domain": {
                 "name": "${K5_CONTRACT}"
               },
               "password": "${K5_PASS}",
               "name": "${K5_USER}"
             }
           },
           "methods": [
             "password"
           ]
         }
       }
     }
     ```
  1. トークン抽出
    JMeterの基本機能(正規表現抽出)で、レスポンスヘッダに含まれているトークンの値を取り出します。
    対象のヘッダは「X-Subject-Token」になります。
    ![トークン抽出](images/auth-token.jpg)
    正規表現の内容については省略します。
  1. カタログ抽出
    JMeterの基本機能(JSON Extractor)で、レスポンスボディのJSONに含まれているカタログ情報を取り出します。
    「JSON Path expressions」にJSONPathを入力する事で、リクエストボディ内から対象となる箇所を全て取得します。
    カタログ情報については「$.token.catalog」で取得が可能です。
    ![カタログ抽出](images/token-catalog.jpg)
  1. プロジェクトID抽出
    カタログ抽出と手順は同じです。プロジェクトIDのJSONPathは「$.token.project.id」になります。

### 外部ネットワーク名取得(API)

- 概要

  スタックを作成するAZで利用可能な外部ネットワーク名を取得します。
  取得した値は、スタック作成時のパラメータとして利用します。
  外部ネットワーク名を直接取得するAPIは用意されていない為、プロジェクトで利用可能なネットワークのリストから該当するものを取得します。
  プロジェクトで利用可能なネットワークの一覧を取得するAPIは以下になります。
  > GET {networkのエンドポイント}/v2.0/networks

  外部ネットワーク名の取得には、APIのクエリパラメータによるフィルターを利用可能です。
  以下は、外部ネットワーク名を取得する為のクエリパラメータになります。
  > ?router:external=true&availability_zone=[AZの指定]&fields=name

- 必要な機能

  WebAPIのリクエスト機能(GET)が必要になります。
  リクエストボディとレスポンスボディのフォーマットはjsonとなっている為、jsonを扱える必要があります。

- 実装時の注意点

  1. 複数の該当ネットワーク名
    APIはjsonのリスト形式でネットワークを返却しますが、リスト内のネットワーク名は単一の場合もあれば、複数存在する場合もあります。
    この為、いずれの場合でも適切なネットワーク名を返却するように構成してください。
    (通常、外部ネットワークはAZにつき１つの取得で問題ありません)

- 実装サンプル(module/get\_ext\_network\_name.jmx)

  サンプルでは以下の手順で処理を行っています。
  1. K5認証呼び出し
  1. エンドポイント取得
  1. 取得リクエスト
  1. 外部ネットワーク名抽出(ランダム)

  以下、各手順の詳細です。
  1. K5認証呼び出し
    認証(API)の部品を呼び出し、トークン、エンドポイント一覧、プロジェクトIDを取得します。
  1. エンドポイント取得※
    JMeterの基本機能(BeanShellサンプラー)を使用して、エンドポイント一覧(カタログ)から指定したエンドポイントを取得するスクリプト(get\_endpoint.bsh)を呼び出します。
    ![エンドポイント取得](images/ext-networks/endpoint.jpg)
    ※以降、各手順ではこの手順の説明については簡略化します。
  1. 取得リクエスト
    取得したエンドポイントとネットワーク情報のパスを組み合わせ、JMeterのHTTPリクエスト機能を使用してAPIリクエストを行っています。
    この際、外部ネットワークの情報のみが取得できるように、クエリパラメータを付加します。(「?」以降)
    ![取得リクエスト](images/ext-networks/request.jpg)
    また、トークンについては「HTTPヘッダマネージャ」を使用して設定します。
    ![ヘッダ設定](images/ext-networks/header.jpg)
  1. 外部ネットワーク名抽出(ランダム)
    JMeterの基本機能(JSON Extractor)で、レスポンスボディのJSONに含まれているネットワーク名を取り出します。
    この際、「Match No.」に0を設定する事で、複数のネットワークがある場合にいずれか一つをランダムで取得するようにします。
    ![外部ネットワーク名抽出](images/ext-networks/ext-network-name.jpg)

### 外部ネットワークID取得(API)

- 概要

  取得した外部ネットワーク名を使用して、ネットワーク情報から外部ネットワークのIDを取得します。
  ネットワーク情報を取得するAPIは以下になります。
  > GET {networkのエンドポイント}/v2.0/networks

- 必要な機能

  WebAPIのリクエスト機能(GET)が必要になります。
  レスポンスボディのフォーマットはjsonとなっている為、jsonを扱える必要があります。

- 実装時の注意点

  特になし

- 実装サンプル(module/get\_resource\_info.jmx)

  サンプルでは以下の手順で処理を行っています。
  1. K5認証呼び出し
  1. エンドポイント取得
  1. リソース情報取得リクエスト
  1. リソース情報抽出

  以下、各手順の詳細です。
  1. K5認証呼び出し
    認証(API)の部品を呼び出し、トークン、エンドポイント一覧、プロジェクトIDを取得します。
  1. エンドポイント取得
    指定されたタイプのエンドポイントを取得します。
  1. リソース情報取得リクエスト
    取得したエンドポイントとリソース情報のパスを組み合わせ、JMeterのHTTPリクエスト機能を使用してAPIリクエストを行います。
  1. リソース情報抽出
    JMeterの基本機能(JSON Extractor)で、レスポンスボディから指定されたJSONPathの値を取り出します。

### DNSサーバリスト取得(非API)

- 概要

  IaaSの共通ネットワークサービスとして提供されているDNSサーバのIPアドレスを取得します。
  取得した値は、スタック作成時のパラメータとして利用されます。
  共通ネットワークサービスの情報はAPIで取得する事が出来ない為、別の手段で取得する必要があります。
  ここでは、共通ネットワークサービスの情報をファイルで保存しておき、実行時に読み込む方法を推奨します。
  情報を保存するファイルのフォーマットに制限はありませんが、APIでも扱う関係からjson形式を推奨します(サンプルではjsonを使用しています)。
  DNSサーバのIPアドレスの値ついては、機能説明書の「共通ネットワークサービス」を参照してください。
  なお、共通ネットワークサービスにはDNSの他にも提供されているサーバが存在します。以下はそのリストになります。
  - DNSサーバ （ネットワークにおける名前解決）
  - yumリポジトリミラーサーバ
  - Red Hat Update Infrastructure (RHUI)
  - SUSE Public Cloud Infrastructure
  - Windowsライセンス認証 (KMS)
  - NTPサーバ
  - WSUS (Windows Server Update Services) サーバ

  全てではありませんが、共通ネットワークサービスの各役割のサーバはAZに対して複数されていますので、冗長化等に利用する場合は、複数の値を取得する事を推奨します。

- 必要な機能

  ファイルの読み込み機能が必要になります。
  ファイルのフォーマットに従い、特定の値を読み取る機能が必要になります。
  (jsonの場合は、JSONPathのような機能です)

- 実装時の注意点

  1. リージョン・AZ毎のアドレス差異
    共通ネットワークサービスで提供されるサーバのIPアドレスはリージョンもしくはAZ毎に異なります。
    その為、リージョンもしくはAZ毎に取得する値を変更できるように構成する必要があります。

- 実装サンプル(module/read\_json\_data.jmx)

  サンプルでは以下の手順で処理を行っています。
  1. ファイルのJSON化
  1. 抽出

  以下、各手順の詳細です。
  1. JSONファイル読み込み
    JMeterの基本機能(BeanShellサンプラー)を使用して、指定されたJSONファイルの内容をレスポンスとして返却するスクリプト(json\_data\_from\_file.bsh)を呼び出します。
    ![JSONファイル読み込み](images/dns-servers/json.jpg)
  1. 抽出
    JMeterの基本機能(JSON Extractor)で、レスポンスのJSONから「${extraction\_path}」で指定されたJSONPathの値を取得します。
    「${extraction\_path}」の値は、この部品の読み込み時に指定されます。

  (補足)
  サンプル上では共通ネットワークサービスの情報が記述されたjsonファイル(data/az\_value.json)を以下の内容で作成します。
  ```
  {
    "jp-east-1a": {
      "name_servers": [
        "133.162.193.9",
        "133.162.193.10"
      ],
      "yum_server": "yum.jp-east-1.cloud.global.fujitsu.com",
      "kms_server": "kms.jp-east-1.cloud.global.fujitsu.com",
      "ntp_servers": [
        "133.162.193.106",
        "133.162.195.141"
      ],
      "wsus_server":"wsus.jp-east-1.cloud.global.fujitsu.com"
    },
    "jp-east-1b": {
      "name_servers": [
        "133.162.201.9",
        "133.162.201.10"
      ],
      "yum_server": "yum.jp-east-1.cloud.global.fujitsu.com",
      "kms_server": "kms.jp-east-1.cloud.global.fujitsu.com",
      "ntp_servers": [
        "133.162.203.207",
        "133.162.203.208"
      ],
      "wsus_server":"wsus.jp-east-1.cloud.global.fujitsu.com"
    },
    ・・・以下、各AZとリージョンが続く・・・
  }
  ```
  上記からjp-east-1bのDNSサーバのリスト("133.162.201.9" 及び "133.162.201.10")を取得する為に指定する「${extraction\_path}」は「$.jp-east-1b.name\_servers」となります。

### キーペアの作成(API)

- 概要

  プロジェクトにキーペアの作成を行います。
  また、キーペアの作成時にレスポンスとして返却される秘密鍵情報を、ファイルとして保存します。
  取得した秘密鍵情報は、ターゲットスタック内の仮想サーバのアクセスに使用します。
  キーペアを作成するAPIは以下になります。
  > POST {computeのエンドポイント}/os-keypairs

  以下に本手順で作成されるキーペアの作成範囲を示します。
  ![構成図](images/keypairs/diagram.jpg)

  なお、予め作成した公開鍵をプロジェクトに登録する事も可能ですが、ここでは取り上げません。詳細はAPIリファレンスを参照してください。

- 必要な機能

  WebAPIのリクエスト機能(POST)が必要になります。
  リクエストボディとレスポンスボディのフォーマットはjsonとなっている為、jsonを扱える必要があります。
  レスポンスボディには秘密鍵が含まれる為、文字列をファイルに保存する機能が必要になります。

- 実装時の注意点

  1. AZの指定
    「availability\_zone」の指定が無い場合は、自動的にリージョン内のいずれかのAZに設定されますので、指定する事を推奨します。
  1. 秘密鍵の取得
    秘密鍵の取得は作成APIのレスポンス以外に出来ない為、必ず取得するようにしてください。

- 実装サンプル(module/create\_keypair.jmx)

  サンプルでは以下の手順で処理を行っています。
  1. K5認証呼び出し
  1. エンドポイント取得
  1. keypairのJSONを作成
  1. リクエストボディのJSONを作成
  1. キーペア作成リクエスト
  1. 秘密鍵抽出
  1. 秘密鍵ファイル出力

  以下、各手順の詳細です。
  1. K5認証呼び出し
    認証(API)の部品を呼び出し、トークン、エンドポイント一覧、プロジェクトIDを取得します。
  1. エンドポイント取得
    computeのエンドポイントを取得します。
  1. keypairのJSONを作成
     JMeterの基本機能(BeanShellサンプラー)を使用して、第ニ引数以降に指定した変数を、第一 引数に指定した変数に(JSON文字列として)格納するスクリプト(add\_variables\_to\_json\_string.bsh)を呼び出します。
     ![keypairのJSONを作成](images/keypairs/keypair-json.jpg)
     ここで変数「keypair」に格納されるJSON文字列は以下になります。
     ```
     {
       "name": "[指定したキーペア名]",
       "availability_zone": "[指定したAZ]"
     }
     ```
  1. リクエストボディのJSONを作成
      「keypairのJSONを作成」と同様にスクリプトを呼び出します。
      ![リクエストボディのJSONを作成](images/keypairs/request-json.jpg)
      ここで変数「request\_body」に格納されるJSON文字列は以下になります。
      ```
      {
        "keypair":{
          "name": "[指定したキーペア名]",
          "availability_zone": "[指定したAZ]"
        }
      }
      ```
  1. キーペア作成リクエスト
     JMeterのHTTPリクエスト機能を使用してkeypairsリクエストを行います。
     リクエストボディには作成した「request\_body」を使用します。
     ![キーペア作成リクエスト](images/keypairs/request.jpg)
  1. 秘密鍵抽出
     JMeterの基本機能(JSON Extractor)で、レスポンスボディのJSONに含まれている秘密鍵を取り 出します。
     ![秘密鍵抽出](images/keypairs/secret-key.jpg)
  1. 秘密鍵ファイル出力
      JMeterの基本機能(BeanShellサンプラー)を使用して、指定した変数の内容を中身を指定した ファイルに出力するスクリプト(variable\_to\_file.bsh)を呼び出します。
      ![秘密鍵ファイル出力](images/keypairs/secret-key-file.jpg)
      作成される秘密鍵の内容は以下のようになります。
      ```
      -----BEGIN RSA PRIVATE KEY-----
      ・・・鍵の文字列・・・
      -----END RSA PRIVATE KEY-----
      ```

### ターゲットスタックの作成(API)

- 概要

  プロジェクトにターゲットスタックの作成を行います。
  スタック作成のAPIは以下になります。
  > POST {オーケストレーションのエンドポイント}/stacks

  スタックの作成のAPIでは、リクエストボディに以下の情報が必要になります。
  - HeatテンプレートorHeatテンプレートにアクセスできるURL ※Heatテンプレートについては「Heatテンプレート解説書」を参照してください。
  - スタック名

  APIについての詳細はAPIリファレンスを参照してください。

  スタック作成は、作成リクエスト時点では完了しておらず、作成完了(ステータス：CREATE\_COMPLETE)まで定期的にステータスを確認する必要があります。

  スタックステータスの確認は、以下のスタック詳細取得APIを呼び出すことで可能です。
  > GET {オーケストレーションのエンドポイント}/stacks/{stack_name}/{stack_id}

  以下に本手順で作成されるターゲットスタックの作成範囲を示します。
  ![構成図](images/stacks/create.jpg)
  スタックで作成した場合、仮想サーバタイプがOSの動作要件を満たさない場合があります。
  この回避の為、チェック機構を入れるか連携ツールの利用時に該当の組み合わせを使用しないようにする必要があります。
  組み合わせの詳細については、機能説明書を参照してください。

- 必要な機能

  WebAPIのリクエスト機能(GET及びPOST)が必要になります。
  リクエストボディとレスポンスボディのフォーマットはjsonとなっている為、jsonを扱える必要があります。
  ファイルの読み込み機能が必要になります。
  スタックの作成完了(もしくは失敗)まで、リクエストを定期的に実行する機能が必要になります。

- 実装時の注意点

  1. Heatテンプレートパラメータ
    Heatテンプレートは通常、parametersセクションでスタック構成時に指定可能なパラメータ名を定義しています(パラメータ名・型・制限・デフォルト値等)。
    自動構築の実行時にパラメータを指定する場合、parametersに定義されたパラメータ名と値の組み合わせを指定する必要があります。
    しかし、入力可能なパラメータ名は、Heatテンプレートを読み込むまで不明な為
    - 自動構築の実行前にテンプレートを読み込みを行い、入力可能なパラメータ名を表示する
    - パラメータ名と値の組み合わせを自由に設定できるようにする(サンプルではこちらで対応しています)
    等の対応が必要になります。
  1. Heatテンプレートのエスケープ
    Heatテンプレートのフォーマットはyamlですが、スタック作成APIのリクエストボディはJSONになっています。
    その為、リクエストボディにHeatテンプレートを直接埋め込む場合は、特殊文字の適切なエスケープが必要になります。

- 実装サンプル(module/create\_stack.jmx)

  サンプルでは以下の手順で処理を行っています。
  1. K5認証呼び出し
  1. エンドポイント取得
  1. スタックパラメータ作成
  1. テンプレート読み込み
  1. リクエストボディ作成
  1. テンプレートチェックリクエスト
  1. スタック作成リクエスト
  1. スタックID抽出
  1. スタック情報取得リクエスト
  1. スタックステータス抽出
  1. スタックステータス判断

  以下、各手順の詳細です。
  1. K5認証呼び出し
    認証(API)の部品を呼び出し、トークン、エンドポイント一覧、プロジェクトIDを取得します。
  1. エンドポイント取得
    オーケストレーションのエンドポイントを取得します。
  1. スタックパラメータ作成
    スクリプト(make\_json\_data\_from\_param.bsh)を使用して、リクエストボディに使用するparametersオプションのJSON文字列を作成します。
    ![スタックパラメータ作成](images/stacks/parameters.jpg)

  1. テンプレート読み込み
    スクリプト(file\_to\_variable.bsh)を使用して、指定されたファイルの内容を変数「template」に入力します。
    ![テンプレート読み込み](images/stacks/templates.jpg)

  1. リクエストボディ作成
    スクリプト(file\_to\_variable.bsh)を使用して、リクエストボディのJSON文字列を作成します。
    ![リクエストボディ作成](images/stacks/request.jpg)

  1. テンプレートチェックリクエスト
    作成リクエストを行なう前に、テンプレートのフォーマットに問題がないかチェックするAPIのリクエストを行っています。※この手順は必須ではありません。
    JMeterのHTTPリクエスト機能を使用します。
    リクエストボディは「リクエストボディ作成」で作成したものを使用します。

  1. スタック作成リクエスト
    JMeterのHTTPリクエスト機能を使用して、スタック作成のAPIリクエストを行います。
    リクエストボディは「リクエストボディ作成」で作成したものを使用します。

  1. スタックID抽出
    JMeterの基本機能(JSON Extractor)で、レスポンスボディからスタックIDの値を取り出します。

  1. スタック情報取得リクエスト
    現在のスタックステータスを取得する為、JMeterのHTTPリクエスト機能を使用して、スタック詳細取得のAPIリクエストを行います。


  1. スタックステータス抽出
    JMeterの基本機能(JSON Extractor)で、レスポンスボディからスタックステータス(stack\_status)を取り出します。

  1. スタックステータス判断
    スクリプト(Judge\_create\_stack\_status.bsh)で、作成が完了もしくは失敗した場合はループを終了するように設定します。
    作成中の場合は、「スタック情報取得リクエスト」に戻ります。

### ターゲットスタックの更新(API)

- 概要

  プロジェクトに作成済みのターゲットスタックに対して、テンプレートの更新を行います。
  更新を行なう理由は、外部ネットワークへ接続するような構成はスタック作成時には行えず、スタック更新機能で行なう必要があるからです。※詳細については「Heatテンプレート解説書」を参照してください。

  また、上記の外部への接続が制限されている理由から、スタックの更新時に各サーバを作成するようにしています。
  サーバ作成時にアップデート等の外部への接続を要しない場合は、「ターゲットスタックの作成」に含んでも問題ありません。

  スタック更新のAPIは以下になります。
  > PUT {オーケストレーションのエンドポイント}/stacks/{stack_name}/{stack_id}

  スタックの更新にはHeatテンプレートが必要になります。
  スタック更新は、更新リクエスト時点では完了しておらず、更新完了(ステータス：UPDATE\_COMPLETE)まで定期的にステータスを確認する必要があります。

  スタックステータスの確認は、以下のスタック詳細取得APIを呼び出すことで可能です。
  > GET {オーケストレーションのエンドポイント}/stacks/{stack_name}/{stack_id}

  以下に本手順で更新されるターゲットスタックの更新範囲を示します。
  ![構成図](images/stacks/update.jpg)

- 必要な機能

  WebAPIのリクエスト機能(GET及びPUT)が必要になります。
  その他は「ターゲットスタックの作成」と同様です。

- 実装時の注意点

  「ターゲットスタックの作成」と同様です。

- 実装サンプル(module/update\_stack.jmx)

  ターゲットスタックの更新手順は作成時と大きく変わらない為、変更箇所のみ記載します。
  作成時と違い、スタックの更新はスタック名とスタックIDの指定が必要となります。
  スタック名については、引数として受け取っている為、以下の手順でスタック名からスタックIDを取得します。
  1. スタックURL取得リクエスト
  1. ロケーションヘッダ抽出
  1. スタックロケーションからスタックIDを抽出

  以下、各手順の詳細です。
  1. スタックURL取得リクエスト
     スタックIDを取得する為、JMeterのHTTPリクエスト機能を使用して、以下のAPIリクエストを行います。
     > GET {オーケストレーションのエンドポイント}/stacks/{stack_name}
  1. ロケーションヘッダ抽出
    「スタックURL取得リクエスト」のレスポンスとしてスタックIDを含めた、Locationヘッダが返却される為、JMeterの基本機能(正規表現抽出)で、対象のヘッダの値を抽出します。
  1. ロケーションヘッダからスタックIDを抽出
    URLの最後のパス以降を取得するスクリプト(get\_last\_path.bsh)を使用して、ロケーションヘッダからスタックIDを抽出します。

### SSL-VPN用ネットワークID取得(API)

- 概要

  ターゲットスタックの情報からSSL-VPN用ネットワークのリソースIDを取得します。

  スタック内のリソース情報は、以下のスタックリソース情報取得APIを呼び出すことで可能です。
  > GET {オーケストレーションのエンドポイント}/stacks/{stack_name}/{stack_id}/{resource_name}

  「ターゲットスタックの更新」と同様にスタック名からスタックIDを取得します。

- 必要な機能

  WebAPIのリクエスト機能(GET)が必要になります。
  レスポンスボディのフォーマットはjsonとなっている為、jsonを扱える必要があります。

- 実装時の注意点

  1. スタック上のIDと実際のID
     スタックの各リソースのIDは、実際に作成されるリソースのIDと異なります。
     リソース情報を取得した際に、実際に作成されるリソースのIDは以下のJSONPathで取得出来ます。
     > $.resource.physical_resource_id
  1. リソース名の指定
     {resource\_name}にはHeatテンプレートで定義したリソース名を指定する必要があります。
     ここで言うリソース名とは、K5上で表示される名前の事ではありません。
     例えば以下のようなHeatテンプレートが記述されていた場合、
     ```
     ・・・(省略)・・・
     resources:
       resouce_name_on_template:
         type: OS::Neutron::Net
         properties:
           name: resouce_name_on_k5
           availability_zone: jp-west-1a
     ・・・(省略)・・・
     ```
     リソース名は「resouce\_name\_on\_k5」ではなく「resouce\_name\_on\_template」です。

- 実装サンプル(module/get\_stack\_resouce\_info.jmx)

  サンプルでは以下の手順で処理を行っています。
  1. K5認証呼び出し
  1. エンドポイント取得
  1. スタックURL取得リクエスト
  1. ロケーションヘッダ抽出
  1. スタックロケーションからスタックIDを抽出
  1. リソース情報取得リクエスト
  1. リソース情報取得

  以下、各手順の詳細です。
  1. K5認証呼び出し
    認証(API)の部品を呼び出し、トークン、エンドポイント一覧、プロジェクトIDを取得します。
  1. エンドポイント取得
    オーケストレーションのエンドポイントを取得します。
  1. スタックURL取得リクエスト
  1. ロケーションヘッダ抽出
  1. スタックロケーションからスタックIDを抽出
    「ターゲットスタックの更新」と同じ手順でスタックIDを取得します。
  1. リソース情報取得リクエスト
    JMeterのHTTPリクエスト機能を使用して、スタックリソース情報取得のAPIリクエストを行います。
  1. リソース情報取得
    JMeterの基本機能(JSON Extractor)で、レスポンスボディから指定されたJSONPathの値を取り出します。

### SSL-VPN用サブネットID取得(API)

- 概要

  ターゲットスタックの情報からSSL-VPN用ネットワークのリソースIDを取得します。
  その他は「SSL-VPN用ネットワークID取得」と同様です。

- 必要な機能

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装時の注意点

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装サンプル(module/get\_stack\_resouce\_info.jmx)

  「SSL-VPN用ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### SSL-VPN用サブネットCIDR取得(API)

- 概要

  取得したSSL-VPN用サブネットIDを使用して、SSL-VPNサブネット情報からCIDRを取得します。
  SSL-VPNサブネット情報を取得するAPIは以下になります。
  > GET {networkのエンドポイント}/v2.0/subnets/{subnet_id}

- 必要な機能

  「外部ネットワークID取得」と同様です。

- 実装時の注意点

  「外部ネットワークID取得」と同様です。

- 実装サンプル(module/get\_resource\_info.jmx)

  「外部ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### 構成管理ツール用キーペアの作成(API)

- 概要

  プロジェクトに構成管理ツール用キーペアの作成を行います。
  その他は「キーペア作成」と同様です。

  以下に本手順で作成される構成管理ツール用キーペアの作成範囲を示します。
  ![構成図](images/cms/keypairs.jpg)

- 必要な機能

  「キーペア作成」と同様です。

- 実装時の注意点

  「キーペア作成」と同様です。

- 実装サンプル(module/create\_keypair.jmx)

  「キーペア作成」と同じ実装サンプルを使用している為、省略します。

### 構成管理ツール用スタックの作成(API)

- 概要

  プロジェクトに構成管理ツール用スタックの作成を行います。
  使用するHeatテンプレートは「ターゲットスタックの作成」とは別のものになります。

  ここで作成されるスタックはOSのセットアップを行なうサーバ(構成管理ツール用サーバ)を含んでいます。
  Heatテンプレートは構成管理ツール用サーバがセットアップ対象にアクセスできるように構成される必要があります。

  また、構成管理ツール用サーバは連携ツールからアクセスできる必要があります。

  上記及びセキュリティ面を考慮し、目標サンプル構成では、SSL-VPN用ネットワークに構成管理ツール用サーバを作成します。

  その他は「ターゲットスタックの作成」と同様です。

  以下に本手順で作成される構成管理ツール用スタックの作成範囲を示します。
  ![構成図](images/cms/stack.jpg)

- 必要な機能

  「ターゲットスタックの作成」と同様です。

- 実装時の注意点

  「ターゲットスタックの作成」と同様です。

- 実装サンプル(module/create\_stack.jmx)

  「ターゲットスタックの作成」と同じ実装サンプルを使用している為、省略します。

### SSL-VPN用ルータID取得(API)

- 概要

  ターゲットスタックの情報からSSL-VPN用ルータのリソースIDを取得します。
  その他は「SSL-VPN用ネットワークID取得」と同様です。

- 必要な機能

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装時の注意点

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装サンプル(module/get\_stack\_resouce\_info.jmx)

  「SSL-VPN用ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### SSL-VPN用ルータポートID取得(API)

- 概要

  ターゲットスタックの情報からSSL-VPN用ルータのポートのリソースIDを取得します。
  その他は「SSL-VPN用ネットワークID取得」と同様です。

- 必要な機能

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装時の注意点

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装サンプル(module/get\_stack\_resouce\_info.jmx)

  「SSL-VPN用ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### SSL-VPN用ルータポートIP取得(API)

- 概要

  取得したSSL-VPN用ルータのポートのリソースIDを使用して、ポート情報からIPを取得します。
  ポート情報を取得するAPIは以下になります。
  > GET {networkのエンドポイント}/v2.0/ports/{port_id}

- 必要な機能

  「外部ネットワークID取得」と同様です。

- 実装時の注意点

  「外部ネットワークID取得」と同様です。

- 実装サンプル(module/get\_resource\_info.jmx)

  「外部ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### SSL-VPN用鍵情報の作成(非API)

- 概要

  SSL-VPNコネクションの作成時に必要な、以下のファイルを「ローカル上」に作成します。
  - (独自)CA証明書
  - DH鍵
  - サーバ証明書
  - サーバ秘密鍵

  また、SSL-VPN接続時に使用する以下のファイルについても作成します。
  - クライアント証明書
  - クライアント秘密鍵

  以下に本手順で作成されるSSL-VPN用鍵情報の作成範囲を示します。
  ![構成図](images/ssl-vpn/create-keys.jpg)

  なお、本手順は自己署名証明書を使用してSS-VPN接続を行なう場合に必要な手順になります。
  K5のクライアント証明書を使用してSSL-VPN接続を行なう場合は不要な手順になります。
  詳細はユーザガイドを参照してください。

- 必要な機能

  各鍵を作成する機能もしくは同様の機能を持つ外部プログラムを実行する機能(サンプルでは外部プログラムとしてOpenSSLを実行します)

- 実装時の注意点

  1. 証明書の拡張属性
    サーバ証明書及びクライアント証明書の作成時にはそれぞれ適切な拡張属性を設定する必要があります。
    ※サンプルで使用しているOpenSSLでは、拡張属性は署名(コマンド「openssl x509」)の際に「-extensions」オプションを使用する事で設定出来ます。
    また、「-extensions」オプションを使用するとopenssl.cnfの該当箇所を参照しますが、「-extfile」オプションを使用する事で、参照するファイルを指定する事が出来ます。
    拡張属性についての詳細はOpenSSLのドキュメントを参照してください。

- 実装サンプル

  この手順では、作成するファイルによって実行する部品が別れている為、それぞれ個別に提示します。

  **(独自)CA証明書、DH鍵の作成(プライベートCA作成.jmx)：**

  サンプルでは以下の手順で処理を行っています。
  1. 秘密鍵＆証明書作成
  1. DH鍵作成

  以下、各手順の詳細です。
  1. 秘密鍵＆証明書作成
    外部プログラムの実行機能として、JMeterの基本機能(OS Process Sampler)を使用し、opensslコマンドを実行して証明書と秘密鍵を作成します。この証明書は自己署名したものになります。
    「-batch」によって非対話での作成を行っています。
    「-subj」はサブジェクトを指定するオプションになります。
    ![証明書署名リクエスト作成](images/ssl-vpn/private-ca-keys.jpg)

  2. DH鍵作成
    秘密鍵＆証明書作成の際と同様に、opensslコマンドを実行してDH鍵を作成します。

    **サーバ証明書・秘密鍵の作成(サーバ証明書作成.jmx)：**

    サンプルでは以下の手順で処理を行っています。
    1. 秘密鍵＆署名リクエスト作成
    1. 証明書作成

  以下、各手順の詳細です。
  1. 秘密鍵＆署名リクエスト作成
    opensslを実行して、証明書署名リクエスト(csrファイル)を作成します。
    秘密鍵は証明書署名リクエストと同時に作成されます。
    ![サーバ証明書作成_証明書署名リクエスト](images/ssl-vpn/cert-csr.jpg)
  1. 証明書作成
    作成した、署名リクエストに対して、CA証明書とCA秘密鍵を使用して署名処理を行っています。
    この際、前述した拡張属性の設定をしています(「-extensions」オプション)。
    ![サーバ証明書作成_証明書作成](images/ssl-vpn/cert-create.jpg)

    **クライアント証明書・秘密鍵の作成(クライアント証明書作成.jmx)：**

    クライアント証明書の作成手順はサーバ証明書と大きく変わらない為、変更箇所のみ記載します。
    変更が必要な箇所は以下になります。
    - 「-extensions」で指定する拡張属性
    - サブジェクト

### SSL-VPN用鍵情報の登録(API)

- 概要

  K5上へ鍵情報の登録を行います。
  使用するAPIは以下になります。
  > POST {鍵管理のエンドポイント}/{tenant_id}/secrets

  登録が必要な鍵情報は以下の通りです。
  - (独自)CA証明書
  - DH鍵
  - サーバ証明書
  - サーバ秘密鍵

  以下に本手順で登録されるSSL-VPN用鍵情報を示します。
  ![構成図](images/ssl-vpn/upload-keys.jpg)

  なお、本手順は自己署名証明書を使用してSS-VPN接続を行なう場合に必要な手順になります。
  K5のクライアント証明書を使用してSSL-VPN接続を行なう場合は不要な手順になります。

- 必要な機能

  鍵情報ファイルを読み込む為、ファイルの入力機能が必要になります。
  WebAPIのリクエスト機能(POST)が必要になります。
  また、リクエストボディとレスポンスボディのフォーマットはjsonとなっている為、jsonを扱える必要があります。

- 実装時の注意点

  1. 鍵の管理単位
    登録した鍵はプロジェクト＋リージョンの単位で管理される為、各AZ間で共有して使用が可能です。
    逆に言えば、AZで別々の鍵を使用する場合は、名前にAZ名を含める等をして、ユーザ側で管理する必要があります。

- 実装サンプル(module/regist\_key.jmx)

  サンプルでは以下の手順で処理を行っています。
  1. K5認証呼び出し
  1. エンドポイント取得
  1. ペイロード作成
  1. リクエストボディ作成
  1. 登録リクエスト
  1. リソースURL抽出

  以下、各手順の詳細です。
  1. K5認証呼び出し
    認証(API)の部品を呼び出し、トークン、エンドポイント一覧、プロジェクトIDを取得します。
  1. エンドポイント取得
    keystoreのエンドポイントを取得します。
  1. ペイロード作成
    スクリプト(file\_to\_variable.bsh)を使用して、指定された鍵情報ファイルの読み込みを行い、変数「payload」に格納します。
  1. リクエストボディ作成
    スクリプト(make\_secrets\_request\_body.bsh)を使用して、リクエストボディを作成します。
    作成するべきリクエストボディの内容についての詳細はAPIリファレンスを参照してください。
  1. 登録リクエスト
    JMeterのHTTPリクエスト機能を使用して、APIリクエストを行います。
    リクエストボディの内容は「リクエストボディ作成」で作成したものを使用します。

  1. リソースURL抽出
    JMeterの基本機能(JSON Extractor)で、レスポンスボディのJSONに含まれている登録した鍵情報のURLを取り出します。
    取得したURLは鍵情報コンテナ作成時に必要になります。

  なお、登録する鍵情報毎に実行が必要になります。

### SSL-VPN用鍵コンテナの作成(API)

- 概要

  鍵情報コンテナを作成します。
  ここで作成する鍵情報コンテナはSSL-VPNに必要な以下の情報を含むものです。
  - 「SSL-VPN用鍵情報の登録」で登録した、(独自)CA証明書のURL
  - 「SSL-VPN用鍵情報の登録」で登録した、サーバ証明書のURL
  - 「SSL-VPN用鍵情報の登録」で登録した、サーバ秘密鍵のURL
  - 「SSL-VPN用鍵情報の登録」で登録した、DH鍵のURL

  使用するAPIは以下になります。
  > POST {鍵管理のエンドポイント}/{tenant_id}/containers

  以下に本手順で作成されるSSL-VPN用鍵コンテナを示します。
  ![構成図](images/ssl-vpn/key-container.jpg)

  なお、本手順は自己署名証明書を使用してSS-VPN接続を行なう場合に必要な手順になります。
  K5のクライアント証明書を使用してSSL-VPN接続を行なう場合は不要な手順になります

- 必要な機能

  WebAPIのリクエスト機能(POST)が必要になります。
  リクエストボディとレスポンスボディのフォーマットはjsonとなっている為、jsonを扱える必要があります。

- 実装時の注意点

  1. コンテナ作成時のリクエストボディ
     コンテナ作成のAPIのリクエストボディは以下のようなフォーマットになっています。
     ```
     {
       "name": "{contatiner_name}",
       "type": "{type}",
       "secret_refs": [
         {
           "name": "{secret_name}",
           "secret_ref": "{secret_ref}"
         },
         ・・・各鍵の情報が続く・・・
       ]
     }
     ```

     SSL-VPN用のコンテナを作成する場合は{secret\_name}において、それぞれ以下を指定する必要があります。
     - (独自)CA証明書：ca
     - サーバ証明書:server\_certificate
     - サーバ秘密鍵:server\_key
     - DH鍵:dh

     また、{type}については「generic」を指定する必要があります。
     詳細はAPIリファレンスを参照してください。

- 実装サンプル(module/create\_key\_container.jmx)

  サンプルでは以下の手順で処理を行っています。
  1. K5認証呼び出し
  1. エンドポイント取得
  1. CA証明書のJSONを作成
  1. サーバ証明書のJSONを作成
  1. サーバ秘密鍵のJSONを作成
  1. DH鍵のJSONを作成
  1. 鍵情報リストのJSONArrayを作成
  1. リクエストボディ作成
  1. 作成リクエスト
  1. リソースURL抽出
  1. リソースURLからコンテナIDを抽出

  以下、各手順の詳細です。
  1. K5認証呼び出し
    認証(API)の部品を呼び出し、トークン、エンドポイント一覧、プロジェクトIDを取得します。
  1. エンドポイント取得
    keystoreのエンドポイントを取得します。
  1. CA証明書のJSONを作成
  1. サーバ証明書のJSONを作成
  1. サーバ秘密鍵のJSONを作成
  1. DH鍵のJSONを作成
    スクリプト(add\_variables\_to\_json\_string.bsh)を使用して、登録した各鍵情報のURLを含んだJSONを作成します。
  1. 鍵情報リストのJSONArrayを作成
    スクリプト(add\_variables\_to\_json\_array\_string.bsh)を使用して、各鍵情報をまとめたJSONArrayを作成します。
  1. リクエストボディ作成
    スクリプト(add\_variables\_to\_json\_string.bsh)を使用して、鍵情報リスト＆名前＆タイプを含んだリクエストボディのJSONを作成します。
  1. 作成リクエスト
    JMeterのHTTPリクエスト機能を使用して、コンテナ作成のAPIリクエストを行います。
    リクエストボディは「リクエストボディ作成」で作成したものを使用します。
  1. リソースURL抽出
    JMeterの基本機能(JSON Extractor)で、レスポンスボディのJSONに含まれている登録した鍵情報コンテナのURLを取り出します。
  1. リソースURLからコンテナIDを抽出
    URLの最後のパス以降を取得するスクリプト(get\_last\_path.bsh)を使用して、リソースURLからコンテナIDを抽出します。

### SSL-VPNサービスの作成(API)

- 概要

  IaaSのAPIを使用して、SSL-VPNサービスを作成します。
  SSL-VPNサービスの作成には以下の情報が必要になります。
  - SSL-VPN接続先サブネットのCIDR
  - SSL-VPNサービスを作成するルータのID

  SSL-VPNサービスを作成するAPIは以下になります。
  > POST {networkのエンドポイント}/v2.0/vpn/vpnservices

  以下に本手順で作成されるSSL-VPNサービスを示します。
  ![構成図](images/ssl-vpn/create-service.jpg)

- 必要な機能

  WebAPIのリクエスト機能(POST)が必要になります。
  リクエストボディとレスポンスボディのフォーマットはjsonとなっている為、jsonを扱える必要があります。

- 実装時の注意点

  特になし

- 実装サンプル(module/create\_ssl-vpn\_service.jmx)

  サンプルでは以下の手順で処理を行っています。
  1. K5認証呼び出し
  1. エンドポイント取得
  1. VPNサービス情報JSON作成
  1. リクエストボディ作成
  1. サービス作成リクエスト
  1. サービスID抽出

  以下、各手順の詳細です。
  1. K5認証呼び出し
    認証(API)の部品を呼び出し、トークン、エンドポイント一覧、プロジェクトIDを取得します。
  1. エンドポイント取得
    networkのエンドポイントを取得します。
  1. VPNサービス情報JSON作成
    スクリプト(add\_variables\_to\_json\_string.bsh)を使用して、VPNサービスの作成に必要なJSONを作成します。
  1. リクエストボディ作成
    スクリプト(add\_variables\_to\_json\_string.bsh)を使用して、「VPNサービス情報JSON作成」で作成したJSONを含んだリクエストボディを作成します。
  1. サービス作成リクエスト
    JMeterのHTTPリクエスト機能を使用して、SSL-VPNサービス作成のAPIリクエストを行います。
    リクエストボディは「リクエストボディ作成」で作成したものを使用します。
  1. サービスID抽出
    JMeterの基本機能(JSON Extractor)で、レスポンスボディのJSONに含まれているSSL-VPNのサービスIDを抽出します。

### SSL-VPNコネクションの作成(API)

- 概要

  IaaSのAPIを使用して、SSL-VPNコネクションを作成します。
  SSL-VPNコネクションの作成には以下の情報が必要になります。
  - SSL-VPNのサービスID
  - 使用する鍵情報コンテナID
  - VPNトンネルの仮想ネットワークCIDR(クライアントアドレスCIDR)

  SSL-VPNコネクションを作成するAPIは以下になります。
  > POST {networkのエンドポイント}/v2.0/vpn/ssl-vpn-v2-connections

  応答が帰ってきた時点ではSSL-VPNコネクションのステータスは「PENDING\_CREATE」となっており、作成は完了していません。
  その為、ステータスが「ACTIVE」になるまで定期的にコネクション情報取得のAPIで確認する必要があります。
  > GET {networkのエンドポイント}/v2.0/vpn/ssl-vpn-v2-connections/{sslvpnv2connection-id}

  ステータスが「ACTIVE」になると以下の「external\_address」にSSL-VPNのグローバルIPアドレスが割り当てられます。
  ```
  {
    "ssl_vpn_v2_connections": [
      {
        "access_points": [
          {
            "floatingip": null,
            "client_address_pool_cidr": "<VPNトンネルの仮想ネットワークcidr  ",
            "internal_gateway": "<SSL-VPNコネクションのプライベートIPアドレス  ",
            "external_address": "<SSL-VPNのグローバルIPアドレス  "
          }
        ],
        ・・・（省略)・・・
        "status": "ACTIVE"
      }
    ]
  }
  ```

  SSL-VPNのグローバルIPアドレスに対して、VPN接続を行なう為、抽出をしておく必要があります。

  以下に本手順で作成されるSSL-VPNコネクションを示します。
  ![構成図](images/ssl-vpn/create-connection.jpg)

- 必要な機能

  WebAPIのリクエスト機能(GET・POST)が必要になります。
  レスポンスボディのフォーマットはjsonとなっている為、jsonを扱える必要があります。
  コネクションの作成完了(もしくは失敗)まで、リクエストを定期的に実行する機能が必要になります。

- 実装時の注意点

  特になし

- 実装サンプル(module/create\_ssl-vpn\_connection.jmx)

  サンプルでは以下の手順で処理を行っています。
  1. K5認証呼び出し
  1. エンドポイント取得
  1. クライアントアドレス情報JSONArray作成
  1. VPNコネクション情報JSON作成
  1. リクエストボディ作成
  1. コネクション作成リクエスト
  1. コネクションID抽出
  1. コネクション作成状況取得リクエスト
  1. コネクション作成状況抽出
  1. 接続用アドレス抽出
  1. floating\_ip\_id抽出
  1. コネクション作成状況判断

  以下、各手順の詳細です。
  1. K5認証呼び出し
    認証(API)の部品を呼び出し、トークン、エンドポイント一覧、プロジェクトIDを取得します。
  1. エンドポイント取得
    networkのエンドポイントを取得します。
  1. クライアントアドレス情報JSONArray作成
    スクリプト(add\_variables\_to\_json\_array\_string.bsh)を使用して、作成するVPNトンネルの仮想ネットワークCIDRのJSONArrayを作成します。
  1. VPNコネクション情報JSON作成
    スクリプト(add\_variables\_to\_json\_string.bsh)を使用して、VPNコネクションの作成に必要なJSONを作成します。
  1. リクエストボディ作成
    スクリプト(add\_variables\_to\_json\_string.bsh)を使用して、「VPNコネクション情報JSON作成」で作成したJSONを含んだリクエストボディを作成します。
  1. コネクション作成リクエスト
    JMeterのHTTPリクエスト機能を使用して、SSL-VPNコネクション作成のAPIリクエストを行います。
    リクエストボディは「リクエストボディ作成」で作成したものを使用します。
  1. コネクションID抽出
    JMeterの基本機能(JSON Extractor)で、レスポンスボディからコネクションIDの値を取り出します。
  1. コネクション情報取得リクエスト
    現在のコネクション作成状況を取得する為、JMeterのHTTPリクエスト機能を使用して、SSL-VPNコネクション情報取得のAPIリクエストを行います。
  1. コネクション作成状況抽出
    JMeterの基本機能(JSON Extractor)で、レスポンスボディからコネクション作成状況の値を取り出します。
  1. 接続用アドレス抽出
    同じく、JMeterの基本機能(JSON Extractor)で、接続用の(グローバルIPアドレス)の値を取り出します。
  1. floating\_ip\_id抽出
    同じく、JMeterの基本機能(JSON Extractor)で、接続用のFIPのIDを取り出します。※コネクション作成時にFIPから割当を行うようにしていない場合は値は設定されません。
  1. コネクション作成状況判断
    スクリプト(judge\_ssl\_vpn\_v2\_connection\_status.bsh)で、作成が完了もしくは失敗した場合はループを終了するように設定します。
    作成中の場合は、「コネクション情報取得リクエスト」に戻ります。

### SSL-VPN接続用設定ファイル作成(非API)

- 概要

  OpenVPN用の設定ファイルを作成します。
  作成には以下を使用します。
  - SSL-VPNのグローバルIPアドレス
  - CA証明書ファイル(のパス)
  - クライアント証明書ファイル(のパス)
  - クライアント秘密鍵ファイル(のパス)

  プロキシサーバを経由してアクセスする場合、以下の情報が必要です。
  - プロキシサーバのアドレス
  - プロキシサーバのポート

  proxy利用の際に認証が必要な場合は、さらに以下の情報が必要です。
  - ユーザ名
  - パスワード

  設定ファイルについての詳細は、OpenVPNの公式ドキュメントを参照してください。

- 必要な機能

  文字列をファイルに保存する機能が必要になります。

- 実装時の注意点

  1. 設定ファイルの記述
    OpenVPNの設定ファイルの記述の仕様に注意してください。
    例えば、クライアント証明書等のファイルを指定する際、パスに空白が含まれる場合は適切なエスケープが必要になります。

- 実装サンプル(module/create\_openvpn\_conf.jmx)

  サンプルでは以下の手順で処理を行っています。
  1. 設定ファイル作成
  1. プロキシ認証情報ファイルの作成※プロキシ及びプロキシ認証を使用するオプションが指定された場合
  1. プロキシ情報＆認証情報の書き込み※プロキシ及びプロキシ認証を使用するオプションが指定された場合
  1. プロキシ情報の書き込み※プロキシを使用するオプションのみ指定された場合
  1. 動作設定情報の書き込み
  1. ファイルのコピー

  以下、各手順の詳細です。
  1. 設定ファイル作成
    スクリプト(input\_to\_file.bsh)を使用して、指定されたファイルパスの空ファイルを作成します。
    先に空ファイルを作成しているのは、この後の手順では、全て追記を行っている為です。
  1. プロキシ認証情報ファイルの作成※プロキシ及びプロキシ認証を使用するオプションが指定された場合
     スクリプト(input\_to\_file.bsh)を使用して、指定されたファイルパスに以下の情報が記述された認証情報ファイルを作成します。
     - ユーザ名
     - パスワード
  1. プロキシ情報＆認証情報の書き込み※プロキシ及びプロキシ認証を使用するオプションが指定された場合
     スクリプト(input\_to\_file.bsh)を使用して、設定ファイルに以下の情報を1行で追記します。
     - プロキシアドレス
     - プロキシポート
     - プロキシ認証情報ファイル名
     - 認証モード
  1. プロキシ情報の書き込み※プロキシを使用するオプションのみ指定された場合
     スクリプト(input\_to\_file.bsh)を使用して、設定ファイルに以下の情報を1行で追記します。
     - プロキシアドレス
     - プロキシポート
  1. 動作設定情報の書き込み
     スクリプト(input\_to\_file.bsh)を使用して、設定ファイルにその他の設定を追記します。
     設定項目が多い為、重要なものを抜粋します。
     - プロトコル
     - デバイス
     - リモートアドレス
     - CA証明書のファイル名
     - クライアント証明書のファイル名
     - クライアント秘密鍵のファイル名
  1. ファイルのコピー
     スクリプト(file\_copy.bsh)を使用して、以下の証明書関係のファイル類を設定ファイルと同じディレクトへコピーします。
     - CA証明書のファイル
     - クライアント証明書のファイル
     - クライアント秘密鍵のファイル

### SSL-VPN接続(非API)

- 概要

  作成したOpenVPN設定ファイルを使用して、SSL-VPN接続を行います。

- 必要な機能

  OpenVPNをバックグラウンドで動作させる為、外部プログラムのバックグラウンド実行機能が必要になります。

- 実装時の注意点

  1. 実行ディレクトリ
    OpenVPNを実行する際のディレクトリに注意してください。
    OpenVPN設定ファイル内の記述が相対パスになっている場合等、実行ディレクトリを適切に設定する必要があります。

- 実装サンプル(module/start\_bg\_process.jmx)

  サンプルでは以下の手順で処理を行っています。
  1. バックグラウンド実行

  以下、各手順の詳細です。
  1. バックグラウンド実行
    プログラムのバックグラウンド実行を行なうスクリプト(start\_bg\_process.bsh)を使用して、指定されたプログラムをバックグラウンドで実行します。
    ![バックグラウンド実行](images/ssl-vpn/connect.jpg)
    第一引数で、実行ディレクトリを指定しています。

### SSL-VPN接続確認(非API)

- 概要

  SSL-VPN接続が成立するまでは程度時間が掛かる為、定期的に接続状況の確認を行います。
  確認の方法としては、以下が考えられます。
  - 接続先ネットワークに対する疎通確認
  - クライアントに追加された仮想インターフェースの確認
  - OpenVPNのログの確認

  ここでは確認方法として、仮想ルータのプライベートIPアドレスに対して疎通確認を行います。
  宛先を仮想ルータにするのは、SSL-VPN接続を作成した時点で確実に存在する為です。

- 必要な機能

  疎通確認の機能が必要になります。

- 実装時の注意点

  1. 接続異常の検知方法
    何らかの理由により、SSL-VPN接続が正常に行えなかった場合の対応が必要になります。
    サンプルでは、リトライ回数の上限を超えた際に、エラーになるようにしています。

- 実装サンプル(module/PING.jmx)

  サンプルでは以下の手順で処理を行っています。
  1. ping実行
  1. ステータス判断

  以下、各手順の詳細です。
  1. ping実行
    指定されたアドレスに対してPINGを実行し、成否を変数に格納するスクリプト(ping.bsh)を呼び出します。
  1. ステータス判断
    成否及びリトライ回数によってループの判断を行ない、結果を変数に格納するスクリプト(loop\_control.bsh)を呼び出します。
    判断結果は指定された変数に格納されます。

### 構成管理ツール用サーバID取得(API)

- 概要

  構成管理ツール用スタックの情報から構成管理ツール用サーバに接続されたポートのリソースIDを取得します。
  その他は「SSL-VPN用ネットワークID取得」と同様です。

- 必要な機能

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装時の注意点

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装サンプル(module/get\_stack\_resource\_info.jmx)

  「SSL-VPN用ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### 構成管理ツール用サーバIP取得(API)

- 概要

  取得した構成管理ツール用サーバのポートのリソースIDを使用して、ポート情報からIPを取得します。
  ポート情報を取得するAPIは以下になります。
  > GET {networkのエンドポイント}/v2.0/ports/{port_id}

- 必要な機能

  「外部ネットワークID取得」と同様です。

- 実装時の注意点

  「外部ネットワークID取得」と同様です。

- 実装サンプル(module/get\_resource\_info.jmx)

  「外部ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### WEBサーバSSL-VPN側ポートID取得(API)

- 概要

  ターゲットスタックの情報からWEBサーバのSSL-VPN用ネットワーク側ポートのリソースIDを取得します。
  その他は「SSL-VPN用ネットワークID取得」と同様です。

- 必要な機能

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装時の注意点

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装サンプル(module/get\_stack\_resource\_info.jmx)

  「SSL-VPN用ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### WEBサーバSSL-VPN側ポートIP取得(API)

- 概要

  取得したWEBサーバのSSL-VPN用ネットワーク側ポートのリソースIDを使用して、ポート情報からIPを取得します。
  ポート情報を取得するAPIは以下になります。
  > GET {networkのエンドポイント}/v2.0/ports/{port_id}

- 必要な機能

  「外部ネットワークID取得」と同様です。

- 実装時の注意点

  「外部ネットワークID取得」と同様です。

- 実装サンプル(module/get\_resource\_info.jmx)

  「外部ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### APPサーバサービス側ポートID取得(API)

- 概要

  ターゲットスタックの情報からAPPサーバのサービス用サブネットのリソースIDを取得します。
  その他は「SSL-VPN用ネットワークID取得」と同様です。

- 必要な機能

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装時の注意点

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装サンプル(module/get\_stack\_resource\_info.jmx)

  「SSL-VPN用ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### APPサーバサービス側ポートID取得(API)

- 概要

  ターゲットスタックの情報からAPPサーバのサービス側ポートのリソースIDを取得します。
  その他は「SSL-VPN用ネットワークID取得」と同様です。

- 必要な機能

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装時の注意点

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装サンプル(module/get\_stack\_resource\_info.jmx)

  「SSL-VPN用ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### APPサーバサービス側ポートIP取得(API)

- 概要

  取得したAPPサーバのサービス側ポートのリソースIDを使用して、ポート情報からIPを取得します。
  ポート情報を取得するAPIは以下になります。
  > GET {networkのエンドポイント}/v2.0/ports/{port_id}

- 必要な機能

  「外部ネットワークID取得」と同様です。

- 実装時の注意点

  「外部ネットワークID取得」と同様です。

- 実装サンプル(module/get\_resource\_info.jmx)

  「外部ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### WEBサーバのセットアップ(非API)

- 概要

  構成管理ツールを使用して、WEBサーバのセットアップを行います。

  ここではAnsibleを使用した実装について記述します。Ansibleの詳細については、公式ドキュメントを参照してください。
  セットアップ対象のOSはLinux系OSを想定しています。※Ansible自体はWindowsにも対応しています。

  セットアップにあたって、必要なファイル類を構成管理ツール用サーバへアップロードします。
  必要なファイルは以下の通りです。
  - WEBサーバへのアクセスに必要な秘密鍵
  - セットアップ内容が記述されたプレイブック

  このファイル類は連携ツールの実行クライアントのローカルファイルとして存在する事を前提としています。

  また、構成管理ツール用サーバにセットアップ対象サーバ専用の以下のファイルを作成する必要があります。
  - セットアップ対象サーバのアクセス情報等が定義されたインベントリファイル
  - セットアップコマンドの動作等の指定する設定ファイル(ansible.cfg)

  構成管理ツール用サーバへのアクセス及びセットアップコマンド(ansible-playbook)の実行はSSHを使用します。

  セットアップの流れは以下のようになります。
  1. 構成管理ツールサーバ上に作業ディレクトリを作成
  1. 必要なファイルのアップロード(及び解凍)
  1. 必要なファイルの作成
  1. 秘密鍵ファイルのアクセス件の設定
  1. セットアップコマンドの実行

  以下に本手順における各サーバとファイルの関係図を示します。
  ![構成図](images/web-servers.jpg)

  一部OSにおいて、ログイン後にセットアッププログラムが走るものがあります。
  そういったものについては、手動でのセットアップをするようにしてください。
  対象のOSについては機能説明書を参照してください。

- 必要な機能

  SSH機能及びSFTPコマンド実行する機能が必要です。
  SSHを利用したファイルアップロード機能が必要です。

- 実装時の注意点

  1. SSHの警告回避
     WEBサーバへアクセスするにあたって、AnsibleからSSHでアクセス初めてアクセスする場合は、OpenSSHのチェック機能により警告が発生し、セットアップがエラーで終了します。
     これを回避する為、サンプルでは「ansible.cfg」に
     ```
     host_key_checking = false
     ```
     を入力します。
  1. 秘密鍵のアクセス権
    アップロードの秘密鍵のアクセス権が適切でない場合、セットアップ時にエラーが発生します。
    chmodコマンドを使用して、アップロードした秘密鍵変更するように実装してください。
  1. 対象ホストのコントロール
     プレイブックに記述している情報と、WEBサーバの情報に齟齬がないようにインベントリファイルを作成するように実装してください。
     例えば
     - WEBサーバのアドレス：192.168.0.5
     - プレイブックのhosts：web-server
    となっている場合、インベントリファイルの内容は
     ```
     [web-server]
     192.168.0.5
     ```
     のように、プレイブックのhostsに記述された内容と、対象ホストのアドレスが紐づく必要があります。

- 実装サンプル(module/run\_Ansible(linux).jmx)

  サンプルでは以下の手順で処理を行っています。
  1. 実行時変数設定
  1. 設定ファイルの設置ディレクトリの作成
  1. プレイブックのアップロード
  1. プレイブックファイル解凍
  1. ターゲット用秘密鍵ファイルのアップロード
  1. インベントリファイル作成
  1. ansible.cfg作成
  1. ターゲット用秘密鍵ファイルのアクセス権変更
  1. セットアップ実行

  以下、各手順の詳細です。
  1. 実行時変数設定
    ansible-playbookコマンドの「--extra-vars」オプションに指定する値の指定がなかった場合に、空の設定を行います。
    「--extra-vars」オプションの詳細については、Ansibleの公式ドキュメントを参照してください。

  1. 設定ファイルの設置ディレクトリの作成
     構成管理ツール用サーバに、セットアップ対象専用の設定ディレクトリを作成する為、SSH接続を行い、以下のコマンドを実行します。
     ```
     mkdir -p ${conf_dst_dir_path}
     ```
     ${}で指定された箇所は該当する変数が展開されます。
     SSHの実行は専用の部品(module/run\_ssh\_command.jmx)を呼び出します。
     部品内ではJMeterに追加した「SSH Command」の機能を使用して、指定されたホストで指定されたコマンドを実行します。
  1. プレイブックのアップロード
    構成管理ツール用サーバに、SFTPを使用してプレイブックファイルのアップロードを行います。
    SFTPの実行は専用の部品(module/run\_sftp\_command.jmx)を呼び出します。
    部品内ではJMeterに追加した「SSH SFTP」の機能を使用して、指定されたホストに指定されたファイルをアップロードを実行します。
  1. プレイブックファイル解凍
    SSH接続を行い、アップロードしたファイルを解凍します。
    このサンプルでは、zip圧縮されている事を前提とした作りになっています。
    SSHの実行は専用の部品(module/run\_ssh\_command.jmx)を呼び出します。
  1. ターゲット用秘密鍵ファイルのアップロード
    SSH接続を行い、アップロードしたファイルを解凍します。
    このサンプルでは、zip圧縮されている事を前提とした作りになっています。
  1. インベントリファイル作成
     インベントリファイルを作成する為、SSH接続を行い、以下のコマンドを実行します。(説明の為、2行に分けていますが、実際には1行です)
     ```
     echo "[${host_group_name}]"    ${conf_dst_dir_path}/${inventory_file_name} ;
     echo "${target_server_port_ip} ansible_ssh_private_key_file=${conf_dst_dir_path}/${key_dst_file_name}"     ${conf_dst_dir_path}/${inventory_file_name}
     ```
     ${}で指定された箇所は該当する変数が展開されます。
     1行目はホストグループ名をインベントリファイルに記述しています。
     2行目は対象ホストと対象ホストに接続する際に使用する秘密鍵のパスを追記しています。
     SSHの実行は専用の部品(module/run\_ssh\_command.jmx)を呼び出しています。
  1. ansible.cfg作成
     ansible.cfgを作成する為、SSH接続を行い、以下のコマンドを実行しています。(説明の為、2行に分けていますが、実際には1行です)
     ```
     echo "[defaults]"    ${conf_dst_dir_path}/ansible.cfg ;
     echo "host_key_checking = False"     ${conf_dst_dir_path}/ansible.cfg
     ```
     ${}で指定された箇所は該当する変数が展開されます。
     1行目はansibleのデフォルトセクションの宣言をしています。
     2行目はSSH接続の際に、OpenSSHのチェック機能による警告を無視する設定を入れています。
     SSHの実行は専用の部品(module/run\_ssh\_command.jmx)を呼び出しています。
  1. ターゲット用秘密鍵ファイルのアクセス権変更
     セットアップ実行時に権限エラーを回避する為、ターゲット用秘密鍵ファイルのアクセス権の変更を以下のコマンドで行います。
     ```
     chmod 600 ${conf_dst_dir_path}/${key_dst_file_name}
     ```
     ${}で指定された箇所は該当する変数が展開されます。
     SSHの実行は専用の部品(module/run\_ssh\_command.jmx)を呼び出しています。
  1. セットアップ実行
     ansible-playbookコマンドを使用して、セットアップを実行します。(説明の為、2行に分けていますが、実際には1行です)
     ```
     cd ${conf_dst_dir_path} ;
     ansible-playbook -i ${conf_dst_dir_path}/${inventory_file_name} --extra-vars ${extra_vars} ${conf_dst_dir_path}/${playbook_file_name}
     ```
     ${}で指定された箇所は該当する変数が展開されます。
     1行目は設定ディレクトリへ移動しています。
     これは、カレントディレクトリに存在するansibe.cfgを読み込ませる為に行っています。
     2行目はセットアップのコマンドになります。
     SSHの実行は専用の部品(module/run\_ssh\_command.jmx)を呼び出しています。

### APPサーバSSL-VPN側ポートID取得(API)

- 概要

  ターゲットスタックの情報からAPPサーバのSSL-VPN用ネットワーク側ポートのリソースIDを取得します。
  その他は「SSL-VPN用ネットワークID取得」と同様です。

- 必要な機能

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装時の注意点

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装サンプル(module/get\_stack\_resource\_info.jmx)

  「SSL-VPN用ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### APPサーバSSL-VPN側ポートIP取得(API)

- 概要

  取得したAPPサーバのSSL-VPN用ネットワーク側ポートのリソースIDを使用して、ポート情報からIPを取得します。
  ポート情報を取得するAPIは以下になります。
  > GET {networkのエンドポイント}/v2.0/ports/{port_id}

- 必要な機能

  「外部ネットワークID取得」と同様です。

- 実装時の注意点

  「外部ネットワークID取得」と同様です。

- 実装サンプル(module/get\_resource\_info.jmx)

  「外部ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### DBサーバID取得(API)

- 概要

  ターゲットスタックの情報からDBサーバのリソースIDを取得します。
  その他は「SSL-VPN用ネットワークID取得」と同様です。

- 必要な機能

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装時の注意点

  「SSL-VPN用ネットワークID取得」と同様です。

- 実装サンプル(module/get\_stack\_resource\_info.jmx)

  「SSL-VPN用ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### DBサーバIP取得(API)

- 概要

  取得したDBサーバのリソースIDを使用して、データベースのインスタンス情報からIPを取得します。
  データベースのインスタンス情報を取得するAPIは以下になります。
  > GET {databaseのエンドポイント}/instances/{instanceId}

- 必要な機能

  「外部ネットワークID取得」と同様です。

- 実装時の注意点

  「外部ネットワークID取得」と同様です。

- 実装サンプル(module/get\_resource\_info.jmx)

  「外部ネットワークID取得」と同じ実装サンプルを使用している為、省略します。

### APPサーバのセットアップ(非API)

- 概要

  構成管理ツールを使用して、APPサーバのセットアップを行います。
  その他は「WEBサーバのセットアップ」と同様です。

- 必要な機能

  「WEBサーバのセットアップ」と同様です。

- 実装時の注意点

  「WEBサーバのセットアップ」と同様です。

- 実装サンプル(module/run\_Ansible(linux).jmx)

  「WEBサーバのセットアップ」と同じ実装サンプルを使用している為、省略します。

### DBサーバへのデータ投入(非API)※APPサーバ経由

- 概要

  構成管理ツールを使用して、APPサーバを経由したDBのセットアップを行います。
  目標サンプルでは、DBサーバはSSL-VPN用ネットワークからのアクセスができない構成の為、APPサーバがDBへデータを投入するプレイブックを用意する必要があります。

  以下に本手順における各サーバとファイルの関係図を示します。
  ![構成図](images/data-import.jpg)
  実現の為にプレイブックは、以下を変数として受け取れる構成にする必要があります。
  - DBの接続アドレス(FQDN)
  - DBのポート
  - DBのユーザ名
  - DBのパスワード
  - DBのデータベース名

  DBの接続アドレス(FQDN)以外はターゲットスタック更新時に指定したものになります。

  その他は「WEBサーバのセットアップ」と同様です。

- 必要な機能

  「WEBサーバのセットアップ」と同様です。

- 実装時の注意点

  「WEBサーバのセットアップ」と同様です。

- 実装サンプル(module/run\_Ansible(linux).jmx)

  「WEBサーバのセットアップ」と同じ実装サンプルを使用している為、省略します。

[\[各手順の連携へ\]](coordination.md)
